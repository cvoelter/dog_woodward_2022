---
title: "Woodward 2022 - pupil size"
author: LL
output: pdf_document
date: `13/04/2023`
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#rm(list=ls())
library(tidyverse)
library(arrow)
library(summarytools)
library(exactRankTests)
library(lme4)
library(naniar)
#library(devtools)
#remotes::install_github("dmirman/gazer")
library(gazer)
library(zoo)
library(wesanderson)
source("functions/diagnostic_fcns.r")
source("functions/glmm_stability.r")
source("functions/boot_glmm.r")


library(itsadug)
packageVersion("itsadug")
library(plotfunctions)
packageVersion("plotfunctions")
library(colorspace)
packageVersion("colorspace")
## Define colors:
col1 <- 'pink1'
col2 <- 'black'
col3 <- 'indianred'
```


## load data

```{r}
## time.frame for interpolation
max.time <- 22000
min.time <- 0
time <- seq(from = min.time, to = max.time, by = 1)
xx <- as.data.frame(time)
str(xx)

baseline.end<-693 #it needs to be when frame 693 is shown, 200 frames after agents' directional cue. Figure out what time is in ms when frame 693 is shown

demo.data <- read_csv("data/Woodward_2022_counterbalancing.csv") %>%
  mutate(
    EDF1 = fct_recode(
      as.factor(EDF1),
      "Georgia_1" = "Georgia1",
    )
  ) %>%
  separate(EDF1, c("subject", "num"), sep = "_")%>%
  select(-num)
```
load sample data and add the demographic data
```{r}
sample.data<-read_parquet("data/Woodward2022_Sample_Report.parquet") %>%
   mutate(RECORDING_SESSION_LABEL=fct_recode(RECORDING_SESSION_LABEL,  Georgia_2="Georgia2",Georgia_1="Georgia1", Georgia_3="Georgia3", Georgia_4="Georgia4"))%>%
  filter(RECORDING_SESSION_LABEL != "Melody_1", RECORDING_SESSION_LABEL != "Mia_5") %>%
  filter(RECORDING_SESSION_LABEL != "Timo_5", RECORDING_SESSION_LABEL != "Joker_5") %>%
  separate(RECORDING_SESSION_LABEL, c("subject", "num"), sep = "_")%>%
  mutate(condition_trial = paste(condition, "_", Trial_Index_)) %>%
  filter(condition != "fam")%>% #retain only test trials
  full_join(demo.data)%>%
  mutate(time = TIMESTAMP - IP_START_TIME) %>% 
  separate(trial_type, into=c("agent", "object", "side"),sep = "_")
```


```{r}
#data checks
str(sample.data)
table(sample.data$subject,sample.data$trial_number)
table(sample.data$subject,sample.data$condition)
table(sample.data$subject,sample.data$agent)
summary(sample.data$time)
summary(sample.data$VIDEO_FRAME_INDEX)
sample.data$RIGHT_PUPIL_SIZE<-as.numeric(sample.data$RIGHT_PUPIL_SIZE)
summary(sample.data$RIGHT_PUPIL_SIZE)
sample.data$RIGHT_GAZE_X<-as.numeric(sample.data$RIGHT_GAZE_X)
summary(sample.data$RIGHT_GAZE_X)
sample.data$RIGHT_GAZE_Y<-as.numeric(sample.data$RIGHT_GAZE_Y)
summary(sample.data$RIGHT_GAZE_Y)
```

##Artefacts check
*Plot raw data
```{r}
raw_plot_pupil<-ggplot(data = sample.data, aes(x = time, y = RIGHT_PUPIL_SIZE)) +
  ylab("Pupil size") +
  xlab("Time (in ms)") +
  geom_point(aes(color = condition), alpha = 0.3, size = 0.5) +
  facet_grid(agent~subject)+
  xlim(0, 22000) +
    theme_bw()+
  scale_color_manual(values=wes_palette("Zissou1")[c(1,4)], labels= c("new goal","new side"))+
  scale_fill_manual(values=wes_palette("Zissou1")[c(1,4)], labels= c("new goal","new side"))+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.title = element_blank(), legend.position = c(0.9, 0.9), legend.text=element_text(size=12))

raw_plot_pupil

ggsave(raw_plot_pupil, filename = "graphs/raw_plot_pupil.png", width=12, height=8, scale=0.8)
```

* Plot with blink artefacts removed
```{r }
sample.data<-sample.data%>%
        mutate(RIGHT_PUPIL_SIZE_no_blinks=extend_blinks(RIGHT_PUPIL_SIZE,  hz=1000, fillback=100, fillforward=100))#Extends blinks


artefact_check <-
  ggplot(data = sample.data,
         aes(x = time, y = RIGHT_PUPIL_SIZE_no_blinks)) +
  ylab("Pupil size") +
  xlab("Time (in ms)") +
  geom_point(aes(color = condition), alpha = 0.3, size = 0.5) +
  facet_grid(agent ~ subject) +
  xlim(0, 22000) +
  theme_bw() +
  scale_color_manual(values = wes_palette("Zissou1")[c(1, 4)],
                     labels = c("new goal", "new side")) +
  scale_fill_manual(values = wes_palette("Zissou1")[c(1, 4)],
                    labels = c("new goal", "new side")) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.title = element_blank(), legend.position = c(0.9, 0.9), legend.text=element_text(size=14)
  )

artefact_check

ggsave(artefact_check, filename = "graphs/artefact_check_100.png", width=12, height=8, dpi=600)
```
#14/04/23: continue from here
Proportion of valid data
```{r}

prop.tracked.data<-sample.data%>%
  group_by(subject, TRIAL_INDEX)%>%
  summarise(length=length(RIGHT_PUPIL_SIZE_no_blinks), sum_noNA=sum(!is.na(RIGHT_PUPIL_SIZE_no_blinks)), prop=sum(!is.na(RIGHT_PUPIL_SIZE_no_blinks))/length(RIGHT_PUPIL_SIZE_no_blinks), min(RIGHT_PUPIL_SIZE), max(RIGHT_PUPIL_SIZE))

prop.tracked.data%>%group_by(TRIAL_INDEX)%>%summarise(min(prop))



prop.tracked.gaze.data<-sample.data%>%
  #filter(time<=4770)%>%
  filter(RIGHT_GAZE_X<1024&RIGHT_GAZE_X>0&RIGHT_GAZE_Y<768&RIGHT_GAZE_Y>0)%>%
  group_by(subject, TRIAL_INDEX)%>%
  summarise(prop=sum(!is.na(RIGHT_GAZE_X))/max(time))

prop.tracked.gaze.data%>%group_by(TRIAL_INDEX)%>%summarise(min(prop), mean(prop))
```
* Plot distribution of pupil sizes
```{r}
puphist <- ggplot(sample.data, aes(x = RIGHT_PUPIL_SIZE_no_blinks)) + geom_histogram(aes(y = ..count..), 
    colour = "green", binwidth = 0.5)  + 
    xlab("Pupil Size") + ylab("Count") + theme_bw() 
puphist
```
#### Preprocessing: interpolation, baseline correction, down sampling
```{r}
# determine baseline
exp.data.pupil.base <- sample.data %>%
  filter(time < baseline.end & time > 0) %>% 
    group_by(subject, TRIAL_INDEX) %>%
  summarise(median.base.pupil = median(RIGHT_PUPIL_SIZE_no_blinks, na.rm = TRUE))

#preprocessing
exp.data.pupil.processed <- sample.data %>%
  filter(time<max.time)%>%
  select(subject, time, TRIAL_INDEX, TRIAL_LABEL, RIGHT_GAZE_X, RIGHT_GAZE_Y, RIGHT_PUPIL_SIZE_no_blinks) %>%
  group_by(subject, TRIAL_INDEX, time) %>%
  full_join(xx%>%select(time)) %>% #add missing time.frames
  ungroup() %>%
  group_by(subject, TRIAL_INDEX) %>%
  mutate(pupil.inter = na.approx(RIGHT_PUPIL_SIZE_no_blinks, na.rm = FALSE, maxgap = 500)) %>% #linear interpolation
  full_join(exp.data.pupil.base) %>% #add baseline data
  mutate(pupil.base.corrected = pupil.inter - median.base.pupil)%>% #subtractive baseline correction
  ungroup()%>%
    mutate(bin = cut(time, seq(min(time), max(time), 100), right = FALSE))%>% #addition of time bins (100 ms = 10 hz)
  separate(bin, c("bin_low", "bin_high"), sep=",", remove=FALSE)%>%
  select(-bin_high)%>%
  mutate(bin_low=as.numeric(str_replace_all(bin_low, "\\[|\\]", "")))
  
#down sampling to 10hz using median values:
exp.data.pupil.processed.downsampled <- exp.data.pupil.processed %>%  
  group_by(subject, TRIAL_INDEX, TRIAL_LABEL, bin_low)%>%
  summarise(pupil.base.corrected.binned=median(pupil.base.corrected), Xgaze=median(RIGHT_GAZE_X), Ygaze=median(RIGHT_GAZE_Y))%>%
  filter(!is.na(subject))%>%
  ungroup()
```


* Plot interpolated data: individual level
```{r}

#exp.data.pupil.processed.downsampled2<-exp.data.pupil.processed.downsampled%>%
#  mutate(condition=fct_recode(condition, "No contact"="exp", "Contact"="con"))

plot.frisbee.triangle.pupil.individual<-ggplot(data = exp.data.pupil.processed.downsampled, aes(x = bin_low, y =pupil.base.corrected.binned )) +
  ylab("Pupil size ") +
  xlab("Time (in ms)") +
    geom_vline(aes(xintercept=baseline.end), lty=2, alpha=0.3)+
  geom_point(aes(color = as.factor(TRIAL_INDEX)), alpha = 0.8, size = 0.5) +
  geom_line(aes(color = as.factor(TRIAL_INDEX)), alpha = 0.8) +
  facet_grid(~subject)+
  xlim(0, 26000) +
    theme_bw()+
  scale_color_brewer(palette="Dark2")+
  scale_fill_brewer(palette="Dark2")+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.title = element_blank(), legend.position = c(0.95,0.9))

plot.frisbee.triangle.pupil.individual
#ggsave(plot.frisbee.triangle.pupil.individual, filename = "graphics/plot.frisbee.triangle.pupil_baseline_corrected_individual.png", height = 7, width = 12, scale = 0.8)
```
* Plot group level data
```{r}

pupil.group.level <- exp.data.pupil.processed.downsampled %>%
  #filter(!is.na(TRIAL_INDEX))%>%
  mutate(TRIAL_LABEL=recode(TRIAL_LABEL, "Trial: 1"="Trial 1", "Trial: 2"="Trial 2"))%>%
  group_by(bin_low, TRIAL_INDEX, TRIAL_LABEL) %>%
  summarise(mean.pupil.corrected.binned = mean(pupil.base.corrected.binned, na.rm = TRUE), sd.pupil.corrected.binned= sd(pupil.base.corrected.binned, na.rm = TRUE), se.pupil.corrected.binned = sd(pupil.base.corrected.binned, na.rm = TRUE) / sqrt(length(pupil.base.corrected.binned)))

plot.frisbee.triangle.pupil <- ggplot(data = pupil.group.level, aes(x = bin_low, y = mean.pupil.corrected.binned)) +
  geom_vline(aes(xintercept=baseline.end), lty=2, alpha=0.3)+
    ylab("Pupil size") +
  xlab("Time (in ms)") +
  geom_point(aes(x = bin_low, y = mean.pupil.corrected.binned, color = TRIAL_LABEL), alpha = 0.3, size = 0.5) +
  geom_ribbon(aes(ymin = mean.pupil.corrected.binned - se.pupil.corrected.binned, ymax = mean.pupil.corrected.binned + se.pupil.corrected.binned, fill = TRIAL_LABEL), alpha = 0.3) +
    xlim(0, 26000) +
    theme_bw()+
  scale_color_brewer(palette="Dark2")+
  scale_fill_brewer(palette="Dark2")+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.title = element_blank(), legend.position = c(0.80, 0.85), legend.text=element_text(size=12))

plot.frisbee.triangle.pupil

#ggsave(plot.frisbee.triangle.pupil, filename = "graphics/plot.frisbee.triangle.pupil_gaze_corrected_2000bl.png", height = 5, width = 8, scale = 0.7, dpi=1200)
```
###GAMM
* Plot gaze positions
```{r}
emptyPlot(c(0,1024), c(768, 0), bty='o',
          main="Gaze positions", xlab="Xgaze", ylab="Ygaze")
points(exp.data.pupil.processed.downsampled$Xgaze, exp.data.pupil.processed.downsampled$Ygaze, pch=16, cex=.5, col=alpha(1), xpd=TRUE)
abline(h=768/2, v=1024/2, lty=1, col='white')
abline(h=768/2, v=1024/2, lty=2, col=1)
```

* Plot pupil size by subject
```{r}
par(cex=1.1)
bp <- sortBoxplot(exp.data.pupil.processed.downsampled$pupil.base.corrected.binned ~ exp.data.pupil.processed.downsampled$subject, col=alpha(1), decreasing=FALSE,
                  ylab="Pupil size", xlab="Subject", bty='n', pch=".")


```
#### data preparation for GAMM

* select interest period
```{r}
dat <- exp.data.pupil.processed.downsampled%>%
  filter(bin_low >= 15000 & bin_low <= 19000)%>% #select interest period
  rename(pupil_base="pupil.base.corrected.binned", time="bin_low")%>%
  arrange(subject,TRIAL_INDEX, TRIAL_LABEL, time)%>%#order dataframe
  droplevels()

dat$TRIAL_LABEL<-as.factor(dat$TRIAL_LABEL)

levels(dat$TRIAL_LABEL)
dat$subject<-as.factor(dat$subject)
summary(dat)
```
#### fitting GAMM

```{r}
# Defining events (time series):
dat$Event <- interaction(dat$subject, dat$TRIAL_LABEL, drop=TRUE)

m2 <- bam(pupil_base ~ TRIAL_LABEL + s(time, k=20)+ s(time, by=TRIAL_LABEL, k=20) 
          + s(Xgaze, Ygaze)
          + s(time, Event, bs='fs', m=1)
          , data=dat, discrete=TRUE, nthreads=40, method="ML")

m2.null <- bam(pupil_base ~ s(time, k=20)+ 
          + s(Xgaze, Ygaze)
          + s(time, Event, bs='fs', m=1)
          , data=dat, discrete=TRUE, nthreads=40, method="ML")
summary(m2)

library(mgcViz)
gam.check(m2)

acf(resid(m2), bty='n', main="ACF residuals model1")
acf(resid(m2), plot=FALSE)

compareML(m2.null, m2)
AIC(m2, m2.null)
```


```{r}
#save gam_check
library(visibly)
png("graphics/GAMM01_gam_check.png", units="cm", res=600, width=24, height = 18)
gam_check_plot<-plot_gam_check(m2, scatter=TRUE)
print(gam_check_plot)
dev.off()

png("graphics/GAMM01_acf_plot.png", units="cm", res=600, width=12, height = 12)
acf_plot<-acf(resid(m2), bty='n', main="")
print(acf_plot)
dev.off()
```
* difference curve
```{r}
#save data
plot_diff_m2_tr1_tr2<-plot_diff(m2, view="time", 
           comp=list(TRIAL_LABEL=c("Trial: 1", "Trial: 2")), rm.ranef=TRUE, 
          las=1, ylab="Est. difference in pupil size", 
          col=col2, hide.label = TRUE, plot = FALSE)

plot_diff_m2_tr1_tr2<-ggplot(data=plot_diff_m2_tr1_tr2, aes(x=time, y=est))+
  geom_hline(yintercept = 0)+
  geom_path(lty=2)+
  geom_ribbon(aes(x=time, ymin=est-CI, ymax=est+CI), alpha=0.2)+
  theme_bw()+
  scale_x_continuous(name="Time (in ms)", breaks=c(15000, 16000, 17000, 18000, 19000))+ ylab("Est. difference in pupil size")+ggtitle("Trial 1 - Trial 2")+
    theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())

plot_diff_m2_tr1_tr2

ggsave(plot_diff_m2_tr1_tr2, filename = "graphics/frisbee_triangle_pupilsize_diff_m2.png", width=8, height=6, scale=0.6, dpi=1200)

```

* plotting partial effects
```{r}
pdf("graphics/frisbee_triangle_m2_GAMM_partial_effect.pdf", width=10, height = 8)
plot(m2, pages = 1, all.terms = TRUE, residuals = TRUE, rug=FALSE, pch = 1, cex = 0.5, seWithMean = TRUE, shade = TRUE, shade.col = "lightblue")
dev.off()

library(mgcViz)
b <- getViz(m2)
png("graphics/frisbee_triangle_m2_GAMM_partial_effect2.png", units="cm", res=600, width=24, height = 16)
p1<-plot(b, allTerms = T)+theme_classic() + labs(title = NULL)
print(p1, pages = 1 )
dev.off()

```
* Summed effects
```{r}

plot_smooth(m2, view="time", cond=list(TRIAL_LABEL="Trial: 1"), rm.ranef=TRUE,
  v0=0, col=col2, lwd=2, lty=6, rug=FALSE, se=1.96,
  main="Estimated effects", ylab="Pupil (baselined)", las=1)

plot_smooth(m2, view="time", cond=list(TRIAL_LABEL="Trial: 2"), rm.ranef=TRUE,
  v0=0, col=col2, lwd=2, lty=6, rug=FALSE, se=1.96,
  main="Estimated effects", ylab="Pupil (baselined)", las=1)

```

```{r}
tmp <- m2$model
plot_modelfit(m2, view="time", event=tmp$Event,n = 2)
```
