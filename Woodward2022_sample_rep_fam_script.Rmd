---
title: "Woodward 2022 - sample report"
output: pdf_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#rm(list=ls())
library(tidyverse)
library(arrow)
library(lme4)
library(cowplot)
library(dplyr)


source("./functions/diagnostic_fcns.r")
source("./functions/glmm_stability.r")
source("./functions/boot_glmm.r")
source("./functions/boot_glmm2.r")
source("./functions/glmmTMB_stability.r")
source("./functions/boot_glmmTMB.r")
source("./functions/extract_ranef_gmmTMB.r")

load("./workspaces/fam.RData")

```
Find the first fixation to object after first fixation at agent and after agent started moving (at around 1600). Delete samples before the agent was looked at and before agent started moving. 
```{r}
#video frame in which the objects starts moving: 646
agent_start_time <- 1600
```


## load data

```{r}
demo.data <- read_csv("data/Woodward_2022_counterbalancing.csv") %>%
  mutate(
    EDF1 = fct_recode(
      as.factor(EDF1),
      "Georgia_1" = "Georgia1",
    )
  ) %>%
  separate(EDF1, c("subject", "num"), sep = "_")%>%
  select(-num)
```
load sample data and add the demographic data
```{r}
sample.data<-read_parquet("data/Woodward2022_Sample_Report.parquet") %>%
    filter(RECORDING_SESSION_LABEL != "Melody_1", RECORDING_SESSION_LABEL != "Mia_5") %>%
  filter(RECORDING_SESSION_LABEL != "Timo_5", RECORDING_SESSION_LABEL != "Joker_5") %>%
  separate(RECORDING_SESSION_LABEL, c("subject", "num"), sep = "_")%>%
  mutate(
    subject = fct_recode(
      subject,
      Georgia = "Georgia1",
      Georgia = "Georgia2",
      Georgia = "Georgia3",
      Georgia = "Georgia4"
    )) %>%
  mutate(condition_trial = paste(condition, "_", Trial_Index_)) %>%
  filter(condition == "fam")%>% #retain familiarisation 
  full_join(demo.data)%>%
  mutate(time = TIMESTAMP - IP_START_TIME)
```

first trial
```{r}
sample.data.ft <- sample.data %>%
  filter(time < 11000) %>% #keep only the first trial of the familiarisation
  #mutate(ref_time = time - agent_arrival_time)%>%
  mutate(overlapping_IA = ifelse(RIGHT_INTEREST_AREAS == "[ 2, 5 ]" | RIGHT_INTEREST_AREAS == "[ 4, 5 ]", "agent_object",
                                 ifelse(RIGHT_INTEREST_AREAS == "[ 2 ]" | RIGHT_INTEREST_AREAS == "[ 4 ]", "object",
                                        ifelse(RIGHT_INTEREST_AREAS == "[ 5 ]", "agent", "")))) %>%
  mutate(IA_LABEL= ifelse(RIGHT_INTEREST_AREA_LABEL %in% c("ball_left_AOI", "ball_right_AOI", "elephant_left_AOI", "elephant_right_AOI"), RIGHT_INTEREST_AREA_LABEL, "")) %>%
  mutate(IA_LABEL2 = IA_LABEL, trial_type2 = trial_type) %>%
  separate(
    IA_LABEL2,
    into = c("ia_object", "ia_side", "ia_label_del"),
    sep = "_"
  ) %>%
  separate(
    trial_type2,
    into = c("trialtype_agent", "trialtype_object", "trialtype_side"),
    sep = "_"
  ) %>%
  separate(
        agent_target_side_first,
        into = c("agent_first", "object_first", "side_first"),
        #shown to the dog in the first session
        sep = "_"
      )%>%
  mutate(
    IA_fam_object = ifelse(ia_object !="" & ia_object == trialtype_object,
      "target",
      ifelse(ia_object !="" & ia_object != trialtype_object,
        "distractor","")))%>%
  mutate(RIGHT_INTEREST_AREA_LABEL = ifelse(               #rename some RIGHT_INTEREST_AREA_LABELS that had the wrong label in the viewing session
    (subject == "Ace" &
       grepl("human", RIGHT_INTEREST_AREA_LABEL)) |
      (subject == "George" &
         grepl("human", RIGHT_INTEREST_AREA_LABEL)) |
      (subject == "Georgia" &
         grepl("human", RIGHT_INTEREST_AREA_LABEL)) |
      (subject == "Joker" &
         grepl("human", RIGHT_INTEREST_AREA_LABEL)) |
      (subject == "Lenny" &
         grepl("human", RIGHT_INTEREST_AREA_LABEL)) |
      (subject == "Melody" &
         grepl("human", RIGHT_INTEREST_AREA_LABEL)) |
      (subject == "Mia" &
         grepl("human", RIGHT_INTEREST_AREA_LABEL)),
    "fam_dyn_human_elephant_left",
    ifelse(
      (subject == "Juna" &
         grepl("human", RIGHT_INTEREST_AREA_LABEL)) |
        (subject == "Maylo" &
           grepl("human", RIGHT_INTEREST_AREA_LABEL)) |
        (subject == "Milo" &
           grepl("human", RIGHT_INTEREST_AREA_LABEL)) |
        (subject == "Timo" &
           grepl("human", RIGHT_INTEREST_AREA_LABEL)) |
        (subject == "Zserbo" &
           grepl("human", RIGHT_INTEREST_AREA_LABEL)),
      "fam_dyn_human_ball_right",
      RIGHT_INTEREST_AREA_LABEL
    )))
```

```{r}
levels(as.factor(sample.data.ft$session_number))
levels(as.factor(sample.data.ft$condition))
levels(as.factor(sample.data.ft$RIGHT_INTEREST_AREAS ))
levels(as.factor(sample.data.ft$RIGHT_INTEREST_AREA_LABEL))
levels(as.factor(sample.data.ft$RIGHT_INTEREST_AREA_ID))
levels(as.factor(sample.data.ft$trial_type))
levels(as.factor(sample.data.ft$IA_fam_object))
levels(as.factor(sample.data.ft$ia_object))
levels(as.factor(sample.data.ft$trialtype_object))
levels(as.factor(sample.data.ft$overlapping_IA))
table(sample.data.ft$subject, sample.data.ft$RIGHT_INTEREST_AREA_LABEL )
table(sample.data.ft$IA_fam_object, sample.data.ft$RIGHT_INTEREST_AREA_LABEL )
xx<-sample.data.ft%>%filter(RIGHT_INTEREST_AREAS == "[ 2, 5 ]" | RIGHT_INTEREST_AREAS == "[ 4, 5 ]") #check that RIGHT_INTEREST_AREA_LABEL always shows the object IAs when object and agent are overlapping --> yes
levels(as.factor(xx$RIGHT_INTEREST_AREA_LABEL))
sample.data.ft%>%filter(is.na(time))
min(sample.data.ft$time)
max(sample.data.ft$time)

table(sample.data.ft$IA_LABEL, sample.data.ft$RIGHT_INTEREST_AREA_LABEL)
table(sample.data.ft$condition, sample.data.ft$subject)
table(sample.data.ft$age, sample.data.ft$subject)
table(sample.data.ft$subject, sample.data.ft$session_number)
object_pref_data<-data.frame(table(sample.data.ft$subject, sample.data.ft$ia_object))%>%
  filter(Var2!="")%>%
  pivot_wider(values_from = Freq, names_from = "Var2")
t.test(object_pref_data$ball, object_pref_data$elephant, paired = TRUE) # no significant preference for one of the objects in the first trial of each fam session
table(sample.data.ft$subject, sample.data.ft$IA_fam_object)
```

identify the time points when the video frame, in which object starts moving after being pushed by agent, is shown
```{r}
ref_time_data<-sample.data.ft %>% filter(SAMPLE_MESSAGE == "video_frame646") %>%
  select(subject, session_number, time)%>%
  rename(agent_arrival_time2 = time)
```

### Analysis of anticipatory looks to target
```{r}
#determine when dogs looked first at the agent
first_look_to_agent <- sample.data.ft %>%
  filter(overlapping_IA %in% c("agent_object", "agent")) %>%
  group_by(subject, session_number) %>%
  summarise(first_agent_look = min(time))
```

Remove data before agent starts moving and before dogs looked at the agent
```{r}
sample.data.ft.al <- sample.data.ft %>%
  filter(RIGHT_IN_BLINK!=1, RIGHT_IN_SACCADE!=1) %>%
  filter(time > agent_start_time) %>% # remove data before the agent starts moving
  full_join(first_look_to_agent) %>%
  filter(time > first_agent_look) %>%# remove data before they looked at the agent for the first time
  full_join(ref_time_data) %>%
  mutate(ref_time = time - agent_arrival_time2)

```
now determine the time when they first look to the object
```{r}
sample.data.ft.al.agg<- sample.data.ft.al%>%
  group_by(subject, session_number, trialtype_agent, trialtype_object, trialtype_side, age, sex, agent_first, IA_fam_object) %>%
  summarise(first_object_look = min(ref_time))%>%
  ungroup() %>%
  filter(IA_fam_object!="") %>%
  mutate(
        session_number = as.numeric(session_number),
        session_withinagent = as.numeric(ifelse(
          session_number >= 3, session_number - 2, session_number
        ))
      )
```
plot the distribution of first object looks
```{r}
sample.data.ft.al.agg2 <- sample.data.ft.al.agg %>%
  group_by(subject, trialtype_agent, IA_fam_object) %>%
  summarise(mean_first_object_look = mean(first_object_look))

fam_gat_dt<-ggplot(sample.data.ft.al.agg2, aes(x=IA_fam_object, y = mean_first_object_look)) +
  facet_wrap(~trialtype_agent)+
  ylab("Gaze arrival time to the objects relative to the agent (ms)")+
  xlab("Object")+
  geom_boxplot(outlier.color = "white")+
  geom_hline(yintercept=0, linetype='dashed', col = 'red')+
  geom_count(alpha=0.4)+
  geom_line(aes(group=subject), lty=2, color="grey")+
  theme_bw()+
  theme(axis.text=element_text(size=12))

ggsave(fam_gat_dt, filename= "graphs/fam_gat_dt.png", height=6, width=10, scale=0.7, dpi=1200)

```
plot the distribution of first object looks, with different panels
```{r}
sample.data.ft.al.agg2 <- sample.data.ft.al.agg %>%
  group_by(subject, trialtype_agent, IA_fam_object) %>%
  summarise(mean_first_object_look = mean(first_object_look))

fam_gat_dt2<-ggplot(sample.data.ft.al.agg2, aes(x=trialtype_agent, y = mean_first_object_look)) +
  facet_wrap(~IA_fam_object)+
  ylab("Gaze arrival time to the objects relative to the agent (ms)")+
  xlab("Agent")+
  geom_boxplot(outlier.color = "white")+
  geom_hline(yintercept=0, linetype='dashed', col = 'red')+
  geom_count(alpha=0.4)+
  geom_line(aes(group=subject), lty=2, color="grey")+
  ylim(-5000, 5000)+
  #geom_segment(data= , aes(x = 1, y = 4800, xend = 2, yend = 4800))+
  #geom_text(data= , aes(x=1.5, y=4850, label=c("ns")))+
  theme_bw()+
  theme(axis.text=element_text(size=12))
fam_gat_dt2



ggsave(fam_gat_dt2, filename= "graphs/fam_gat_dt2.png", height=6, width=10, scale=0.7, dpi=1200)

```
plot the distribution of first object looks, with different panels, jittered points and significance levels
```{r}
sample.data.ft.al.agg.target <- sample.data.ft.al.agg %>%
  group_by(subject, trialtype_agent, IA_fam_object) %>%
  filter(IA_fam_object=="target")%>% 
  summarise(mean_first_object_look = mean(first_object_look))

#target plot
fam_gat_target<-ggplot(sample.data.ft.al.agg.target, aes(x=trialtype_agent, y = mean_first_object_look)) +
  ylab("Gaze arrival time to the target relative to the agent (ms)")+
  xlab("Agent")+
  geom_boxplot(outlier.color = "white")+
  geom_hline(yintercept=0, linetype='dashed', col = 'red')+
  geom_jitter(width = 0.2, alpha=0.4, size=2)+
  geom_line(aes(group=subject), lty=2, color="grey")+
  ylim(-5000, 5000)+
  geom_segment(data= , aes(x = 1, y = 4800, xend = 2, yend = 4800))+
  geom_text(data= , aes(x=1.5, y=4850, label=c("*")), size=9)+
  theme_bw()+
  theme(axis.text=element_text(size=12))+
  theme(axis.title=element_text(size=12))
fam_gat_target

#distractor plot
sample.data.ft.al.agg.distractor <- sample.data.ft.al.agg %>%
  group_by(subject, trialtype_agent, IA_fam_object) %>%
  filter(IA_fam_object=="distractor")%>% 
  summarise(mean_first_object_look = mean(first_object_look))

fam_gat_distractor<-ggplot(sample.data.ft.al.agg.distractor, aes(x=trialtype_agent, y = mean_first_object_look)) +
  ylab("Gaze arrival time to the distractor relative to the agent (ms)")+
  xlab("Agent")+
  geom_boxplot(outlier.color = "white")+
  geom_hline(yintercept=0, linetype='dashed', col = 'red')+
  geom_jitter(width = 0.2, alpha=0.3, size=2)+
  geom_line(aes(group=subject), lty=2, color="grey")+
  ylim(-5000, 5000)+
  #geom_segment(data= , aes(x = 1, y = 4800, xend = 2, yend = 4800))+
  #geom_text(data= , aes(x=1.5, y=4850, label=c("ns")))+
  theme_bw()+
  theme(axis.text=element_text(size=12))+
  theme(axis.title=element_text(size=12))
fam_gat_distractor

fam_ft_gat<-plot_grid(fam_gat_target, NULL, fam_gat_distractor, labels = c("A)","","B)"), 
                      rel_widths=c(1, 0.07, 1), label_size = 12,
                      nrow=1,
                      label_x = 0,label_y=1,
                      hjust = 0.8, vjust=-0.8)+
            theme(plot.margin = unit(c(1.3,0.2,0.3,1), "lines"))
fam_ft_gat

ggsave(fam_ft_gat, filename= "graphs/fam_gat_grid.png", height=5, width=7, #scale=0.7, 
       dpi=1200)

```

## preregistered analysis

```{r}
sample.data.ft.al.target <- sample.data.ft.al.agg %>%
  filter(IA_fam_object == "target")
sample.data.ft.al.target$z.session <- as.vector(scale(sample.data.ft.al.target$session_withinagent, center =TRUE, scale = TRUE))
sample.data.ft.al.target$trialtype_agent.c <-
  as.vector(scale(as.numeric(
    as.factor(sample.data.ft.al.target$trialtype_agent)
  ), center = TRUE, scale = FALSE))


```

```{r}
xx.fe.re=fe.re.tab(fe.model="first_object_look ~ trialtype_agent + agent_first + z.session",
re="(1|subject)", data=sample.data.ft.al.target)
xx.fe.re$summary

table(sample.data.ft.al.target$trialtype_agent, sample.data.ft.al.target$subject )
```

fit model (testing the latency of the first look to the target object in the first familiarisation trial)
```{r}

mm1.ft.al<-lme4::lmer(first_object_look ~ trialtype_agent + agent_first + z.session +
            (1+z.session|subject), data=sample.data.ft.al.target, REML=FALSE)

```

```{r}
diagnostics.plot(mm1.ft.al, size.fac=2)

ranef.diagn.plot(mm1.ft.al)
```
collinearity 
```{r}
library(car)
xx<-lm(first_object_look ~ trialtype_agent + agent_first + z.session,
             data=sample.data.ft.al.target, REML=FALSE)
vif(xx)
```


Individual fixed effects
```{r}
summary(mm1.ft.al)$coefficients

library(lmerTest)

mm1.ft.al.reml <-
  lmerTest::lmer(
    first_object_look ~ trialtype_agent + agent_first + z.session +
      (1 + z.session |
         subject),
    data = sample.data.ft.al.target,
    REML = TRUE
  )
summary(mm1.ft.al.reml)
#

```

model stability: latency 

```{r}
source("functions/glmm_stability.r")
full.stab.mm1.ft.al=glmm.model.stab(model.res=mm1.ft.al, contr=NULL,
para=F, data=NULL)

table(full.stab.mm1.ft.al$detailed$lme4.warnings)
table(full.stab.mm1.ft.al$detailed$opt.warnings)#no warnings

#table with model stability
round(full.stab.mm1.ft.al$summary[, -1], 3)

#plotting stability
is.re.latency=grepl(x=rownames(full.stab.mm1.ft.al$summary), pattern="@")
png("graphs/mm1_ft_al__familiarisation_stability_plot.png")
m.stab.plot(full.stab.mm1.ft.al$summary[!is.re.latency, -1])#fixed effects
dev.off()
m.stab.plot(full.stab.mm1.ft.al$summary[is.re.latency, -1])#random effect
```
confidence intervals: latency
```{r}
source("functions/boot_glmm.r")
boot.full.mm1.ft.al=boot.glmm.pred(model.res=mm1.ft.al, excl.warnings=F,
nboots=1000, para=T, n.cores=3, resol=1000, level=0.95)
round(boot.full.mm1.ft.al$ci.estimates, 3)
#visualize cis
m.stab.plot(boot.full.mm1.ft.al$ci.estimates)
```
###Output table: latency - target
```{r}
model_table_ft_al_fam<- bind_cols(as.data.frame(summary(mm1.ft.al)$coefficients),
                            boot.full.mm1.ft.al$ci.estimates[1:4,],
                            summary(mm1.ft.al.reml)$coefficients,
                            full.stab.mm1.ft.al$summary[1:4, -1])%>% 
  select(Estimate=`Estimate...1`, SE = `Std. Error...2`, LowerCI = X2.5., UpperCI = X97.5.,t=`t value...10`, Df=`df`, p=`Pr(>|t|)`, `min`, `max`) %>%
  mutate(across(.cols = c(p), ~ format(round(.x, 3), nsmall=3))) %>% 
  mutate(across(.cols = c(Estimate:Df, min, max), ~ format(round(.x, 2), nsmall=2))) %>% 
# mutate(across(Chi2:p_LRT, ~replace_na(.x, "")))%>%
  mutate(p=replace(p, p==0.000, "<0.001"))

write.csv(model_table_ft_al_fam, file = "saves/mm1_ft_al_fam.csv")
```
##descriptive stats
```{r}
sample.data.ft.al.descr<-sample.data.ft.al.agg2  %>%
  group_by(trialtype_agent, IA_fam_object) %>% 
  summarise(mean_latency=mean(mean_first_object_look),
            sd_latency=sd(mean_first_object_look))
```
## one-sample t-test: compare the onset of the first fixation to the target and distractor object to the reference time when the object starts moving.

```{r}
library(broom)
sample.data.ft.al.ttest<-sample.data.ft.al.agg2  %>%
  group_by(trialtype_agent, IA_fam_object) %>% 
  summarise(ttest = list(t.test(mean_first_object_look, mu=0))) %>%
  mutate(ttest = map(ttest, tidy)) %>%
  unnest(cols = c(ttest))

p.adjust(sample.data.ft.al.ttest$p.value, method = "holm", n = length(sample.data.ft.al.ttest$p.value))#when correcting for multiple comparisons, the trends disappear
```

##LMM distractor

```{r}
sample.data.ft.al.distractor <- sample.data.ft.al.agg %>%
  filter(IA_fam_object == "distractor")
sample.data.ft.al.distractor$z.session <- as.vector(scale(sample.data.ft.al.distractor$session_withinagent, center =TRUE, scale = TRUE))
sample.data.ft.al.distractor$trialtype_agent.c <-
  as.vector(scale(as.numeric(
    as.factor(sample.data.ft.al.distractor$trialtype_agent)
  ), center = TRUE, scale = FALSE))


```

```{r}
xx.fe.re=fe.re.tab(fe.model="first_object_look ~ trialtype_agent + agent_first + z.session",
re="(1|subject)", data=sample.data.ft.al.distractor)
xx.fe.re$summary

table(sample.data.ft.al.distractor$trialtype_agent, sample.data.ft.al.distractor$subject )
```

fit model (testing the latency of the first look to the distractor object in the first familiarisation trial)
```{r}

mm1.ft.al.distractor<-lme4::lmer(first_object_look ~ trialtype_agent + agent_first + z.session +
            (1+z.session||subject), data=sample.data.ft.al.distractor, REML=FALSE)

```

```{r}
diagnostics.plot(mm1.ft.al.distractor, size.fac=2)

ranef.diagn.plot(mm1.ft.al.distractor)
```
collinearity 
```{r}
library(car)
xx<-lm(first_object_look ~ trialtype_agent + agent_first + z.session,
             data=sample.data.ft.al.distractor, REML=FALSE)
vif(xx)
```


Individual fixed effects
```{r}
summary(mm1.ft.al.distractor)$coefficients

library(lmerTest)

mm1.ft.al.distractor.reml <-
  lmerTest::lmer(
    first_object_look ~ trialtype_agent + agent_first + z.session +
      (1 + z.session ||
         subject),
    data = sample.data.ft.al.distractor,
    REML = TRUE
  )
summary(mm1.ft.al.distractor.reml)
#

```

model stability: latency 

```{r}
source("functions/glmm_stability.r")
full.stab.mm1.ft.al.distractor=glmm.model.stab(model.res=mm1.ft.al.distractor, contr=NULL,
para=F, data=NULL)

table(full.stab.mm1.ft.al.distractor$detailed$lme4.warnings)
table(full.stab.mm1.ft.al.distractor$detailed$opt.warnings)#no warnings

#table with model stability
round(full.stab.mm1.ft.al.distractor$summary[, -1], 3)

#plotting stability
is.re.latency.distractor=grepl(x=rownames(full.stab.mm1.ft.al.distractor$summary), pattern="@")
png("graphs/mm1_ft_al__familiarisation_stability_plot.png")
m.stab.plot(full.stab.mm1.ft.al.distractor$summary[!is.re.latency.distractor, -1])#fixed effects
dev.off()
m.stab.plot(full.stab.mm1.ft.al.distractor$summary[is.re.latency.distractor, -1])#random effect
```
confidence intervals: latency
```{r}
source("functions/boot_glmm.r")
boot.full.mm1.ft.al.distractor=boot.glmm.pred(model.res=mm1.ft.al.distractor, excl.warnings=F,
nboots=1000, para=T, n.cores=3, resol=1000, level=0.95)
round(boot.full.mm1.ft.al.distractor$ci.estimates, 3)
#visualize cis
m.stab.plot(boot.full.mm1.ft.al.distractor$ci.estimates)
```
###Output table: latency - target
```{r}
model_table_ft_al_fam.distractor<- bind_cols(as.data.frame(summary(mm1.ft.al.distractor)$coefficients),
                            boot.full.mm1.ft.al.distractor$ci.estimates[1:4,],
                            summary(mm1.ft.al.distractor.reml)$coefficients,
                            full.stab.mm1.ft.al.distractor$summary[1:4, -1])%>% 
  select(Estimate=`Estimate...1`, SE = `Std. Error...2`, LowerCI = X2.5., UpperCI = X97.5.,t=`t value...10`, Df=`df`, p=`Pr(>|t|)`, `min`, `max`) %>%
  mutate(across(.cols = c(p), ~ format(round(.x, 3), nsmall=3))) %>% 
  mutate(across(.cols = c(Estimate:Df, min, max), ~ format(round(.x, 2), nsmall=2))) %>% 
# mutate(across(Chi2:p_LRT, ~replace_na(.x, "")))%>%
  mutate(p=replace(p, p==0.000, "<0.001"))

write.csv(model_table_ft_al_fam.distractor, file = "saves/mm1_ft_al_fam.distractor.csv")
```




